<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MeMo Bot Monitor - Health Status</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Critical Alert Banner */
        .alert-banner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
            color: white;
            padding: 30px;
            text-align: center;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            animation: pulse 1s infinite;
        }
        
        .alert-banner.active {
            display: block;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .alert-banner h1 {
            font-size: 48px;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            animation: shake 0.5s infinite;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .alert-banner .message {
            font-size: 24px;
            margin-bottom: 20px;
        }
        
        .alert-banner .details {
            font-size: 18px;
            opacity: 0.9;
            margin-bottom: 30px;
        }
        
        .alert-banner button {
            background: white;
            color: #ff0000;
            border: none;
            padding: 20px 60px;
            font-size: 24px;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }
        
        .alert-banner button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
        }
        
        /* Warning Banner */
        .warning-banner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);
            color: white;
            padding: 20px;
            text-align: center;
            z-index: 999;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        
        .warning-banner.active {
            display: block;
        }
        
        .warning-banner h2 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .warning-banner button {
            background: white;
            color: #ff9800;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            margin-top: 15px;
        }
        
        /* Dashboard */
        .dashboard {
            background: white;
            border-radius: 20px;
            padding: 40px;
            margin-top: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            color: #667eea;
            font-size: 42px;
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            color: #666;
            font-size: 18px;
        }
        
        .status-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .status-card.healthy {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .status-card.warning {
            background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);
        }
        
        .status-card.critical {
            background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
        }
        
        .status-card h2 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .status-card .time {
            opacity: 0.9;
            font-size: 16px;
        }
        
        .checks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .check-item {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            border-left: 5px solid #667eea;
        }
        
        .check-item.healthy {
            border-left-color: #38ef7d;
        }
        
        .check-item.unhealthy {
            border-left-color: #ff0000;
        }
        
        .check-item h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .check-item .status {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .check-item .status.ok {
            color: #38ef7d;
        }
        
        .check-item .status.error {
            color: #ff0000;
        }
        
        .check-item .details {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .auto-refresh {
            text-align: center;
            margin-top: 30px;
            color: #666;
            font-size: 14px;
        }
        
        /* Control Panel */
        .control-panel {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .control-panel h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 28px;
        }
        
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .control-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 20px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .control-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .control-button:active {
            transform: translateY(0);
        }
        
        .control-button.danger {
            background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
        }
        
        .control-button.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .control-button.warning {
            background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }
        
        .notification-status {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .notification-status h3 {
            color: #333;
            margin-bottom: 15px;
        }
        
        .notification-status .status-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .notification-status .status-indicator.active {
            background: #38ef7d;
        }
        
        .notification-status .status-indicator.inactive {
            background: #ff0000;
        }
        
        /* Environment Monitoring Section */
        .env-monitor-section {
            margin-top: 30px;
        }
        
        .env-monitor-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 28px;
            text-align: center;
        }
        
        .env-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .env-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .env-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 3px solid #ddd;
            transition: all 0.3s;
        }
        
        .env-card.online {
            border-color: #38ef7d;
            background: linear-gradient(135deg, rgba(17, 153, 142, 0.05) 0%, rgba(56, 239, 125, 0.05) 100%);
        }
        
        .env-card.offline {
            border-color: #ff0000;
            background: linear-gradient(135deg, rgba(255, 0, 0, 0.05) 0%, rgba(204, 0, 0, 0.05) 100%);
            animation: pulse-red 2s infinite;
        }
        
        @keyframes pulse-red {
            0%, 100% {
                box-shadow: 0 10px 30px rgba(255, 0, 0, 0.3);
            }
            50% {
                box-shadow: 0 10px 50px rgba(255, 0, 0, 0.6);
            }
        }
        
        .env-card.unknown {
            border-color: #ff9800;
            background: linear-gradient(135deg, rgba(255, 152, 0, 0.05) 0%, rgba(255, 87, 34, 0.05) 100%);
        }
        
        .env-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        
        .env-name {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .env-badge {
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .env-badge.online {
            background: #d1fae5;
            color: #065f46;
        }
        
        .env-badge.offline {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .env-badge.unknown {
            background: #fef3c7;
            color: #92400e;
        }
        
        .env-details {
            margin-top: 20px;
        }
        
        .env-detail-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .env-detail-row:last-child {
            border-bottom: none;
        }
        
        .env-detail-label {
            color: #666;
            font-size: 14px;
        }
        
        .env-detail-value {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }
        
        .env-detail-value.critical {
            color: #ff0000;
            font-weight: 900;
            font-size: 16px;
        }
        
        .deployment-config-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
        }
        
        .deployment-config-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .config-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .config-item:last-child {
            border-bottom: none;
        }
        
        .config-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 16px;
        }
        
        .config-icon.ok {
            background: #d1fae5;
            color: #065f46;
        }
        
        .config-icon.error {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .config-text {
            flex: 1;
            color: #333;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- Critical Alert Banner -->
    <div id="criticalAlert" class="alert-banner">
        <h1>‚ö†Ô∏è CRITICAL ALERT ‚ö†Ô∏è</h1>
        <div class="message" id="alertMessage"></div>
        <div class="details" id="alertDetails"></div>
        <button onclick="acknowledgeAlert()">IT'S OK - I'LL FIX IT</button>
    </div>
    
    <!-- Warning Banner -->
    <div id="warningAlert" class="warning-banner">
        <h2>‚ö° Warning</h2>
        <div class="message" id="warningMessage"></div>
        <button onclick="acknowledgeWarning()">ACKNOWLEDGE</button>
    </div>
    
    <!-- Dashboard -->
    <div class="container">
        <div class="dashboard">
            <div class="header">
                <h1>ü§ñ MeMo Bot Monitor</h1>
                <p class="subtitle">Real-time Health Monitoring System</p>
            </div>
            
            <div id="statusCard" class="status-card">
                <h2 id="overallStatus">Checking...</h2>
                <div class="time" id="lastCheck">Initializing...</div>
            </div>
            
            <div id="checksGrid" class="checks-grid">
                <!-- Health checks will be populated here -->
            </div>
            
            <!-- Environment Monitoring Section -->
            <div class="env-monitor-section">
                <h2>üåç Environment Status</h2>
                <div class="env-grid">
                    <!-- Development Environment -->
                    <div id="devEnvCard" class="env-card unknown">
                        <div class="env-card-header">
                            <div class="env-name">üîß Development</div>
                            <div id="devEnvBadge" class="env-badge unknown">CHECKING...</div>
                        </div>
                        <div class="env-details">
                            <div class="env-detail-row">
                                <div class="env-detail-label">Last Seen</div>
                                <div id="devLastSeen" class="env-detail-value">-</div>
                            </div>
                            <div class="env-detail-row">
                                <div class="env-detail-label">Time Since Heartbeat</div>
                                <div id="devSecondsAgo" class="env-detail-value">-</div>
                            </div>
                            <div class="env-detail-row">
                                <div class="env-detail-label">Status</div>
                                <div id="devStatus" class="env-detail-value">Initializing...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Production Environment -->
                    <div id="prodEnvCard" class="env-card unknown">
                        <div class="env-card-header">
                            <div class="env-name">üöÄ Production</div>
                            <div id="prodEnvBadge" class="env-badge unknown">CHECKING...</div>
                        </div>
                        <div class="env-details">
                            <div class="env-detail-row">
                                <div class="env-detail-label">Last Seen</div>
                                <div id="prodLastSeen" class="env-detail-value">-</div>
                            </div>
                            <div class="env-detail-row">
                                <div class="env-detail-label">Time Since Heartbeat</div>
                                <div id="prodSecondsAgo" class="env-detail-value">-</div>
                            </div>
                            <div class="env-detail-row">
                                <div class="env-detail-label">Status</div>
                                <div id="prodStatus" class="env-detail-value">Initializing...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Deployment Configuration -->
                <div class="deployment-config-section">
                    <h3>‚öôÔ∏è Deployment Configuration</h3>
                    <div id="deploymentConfigItems">
                        <!-- Config items will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- Remote Control Panel -->
            <div class="control-panel">
                <h2>üéõÔ∏è Remote Control Panel</h2>
                
                <div class="notification-status">
                    <h3>
                        <span class="status-indicator active" id="notifIndicator"></span>
                        Notification System Status
                    </h3>
                    <div id="notifDetails">
                        <p>‚ö° Instant Alerts: <strong id="instantStatus">Checking...</strong></p>
                        <p>üìä 2-Hour Summaries: <strong id="summaryStatus">Checking...</strong></p>
                        <p>üë• Active Users: <strong id="activeUsers">-</strong></p>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Total Users</div>
                        <div class="stat-value" id="totalUsers">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Subscribed</div>
                        <div class="stat-value" id="subscribedUsers">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Checks/Min</div>
                        <div class="stat-value">60</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Bot Version</div>
                        <div class="stat-value" style="font-size: 24px;">1.0</div>
                    </div>
                </div>
                
                <div class="control-grid">
                    <button class="control-button success" onclick="sendTestNotification()">
                        üì§ Send Test Notification
                    </button>
                    <button class="control-button" onclick="viewBotLogs()">
                        üìã View Bot Logs
                    </button>
                    <button class="control-button warning" onclick="restartBot()">
                        üîÑ Restart Bot
                    </button>
                    <button class="control-button" onclick="viewUserStats()">
                        üë• User Statistics
                    </button>
                </div>
            </div>
            
            <div class="auto-refresh">
                ‚ü≥ Auto-refreshing every 10 seconds
            </div>
        </div>
    </div>
    
    <!-- Audio alert -->
    <audio id="alertSound" loop>
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjOM0vPTgjMGHm7A7+OZUR4PU5fY8MJrIgY5j9Xy02IqBSl7x/DOmUYOGGW37OaoYBsNTqXh8bllHQc2jdLzz4k3CRp3wvDem08WFl+y6eaqaR4NUKfh8bNlHQY6kNPz0IE3CiF3wvDek1EYGWe56OWpYhwOTqXh8bplHgc1jNLzz4k3CRt3wvDem08VGF+w6eiqYhwNT6fh8bJmHQY6kNPz0IE3CiF3wvDek1EXGWi56OWpYhwOT6Xi8bNkHQY7kNPz0IIyCiF2wvDek1EYGWa36Oiqa" preload="auto"></audio>
    
    <script>
        let alertSound = document.getElementById('alertSound');
        let soundPlaying = false;
        let acknowledgedAlerts = new Set();
        
        async function checkHealth() {
            try {
                const response = await fetch('/api/monitor/health');
                const data = await response.json();
                updateDashboard(data);
                handleAlerts(data);
            } catch (error) {
                console.error('Error checking health:', error);
                showCriticalAlert('Monitor Connection Lost', 'Unable to reach monitoring service');
            }
        }
        
        function updateDashboard(data) {
            // Update overall status
            const statusCard = document.getElementById('statusCard');
            const overallStatus = document.getElementById('overallStatus');
            const lastCheck = document.getElementById('lastCheck');
            
            statusCard.className = 'status-card ' + data.overall_status;
            
            if (data.overall_status === 'healthy') {
                overallStatus.textContent = '‚úÖ All Systems Operational';
            } else if (data.overall_status === 'warning') {
                overallStatus.textContent = '‚ö†Ô∏è System Warning Detected';
            } else {
                overallStatus.textContent = 'üö® CRITICAL ISSUES DETECTED';
            }
            
            lastCheck.textContent = 'Last check: ' + new Date(data.timestamp).toLocaleString();
            
            // Update health checks
            const checksGrid = document.getElementById('checksGrid');
            checksGrid.innerHTML = '';
            
            for (const [key, check] of Object.entries(data.checks)) {
                const checkItem = document.createElement('div');
                checkItem.className = 'check-item ' + (check.healthy ? 'healthy' : 'unhealthy');
                
                const title = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                
                checkItem.innerHTML = `
                    <h3>${title}</h3>
                    <div class="status ${check.healthy ? 'ok' : 'error'}">
                        ${check.status}
                    </div>
                    ${check.error ? `<div class="details">‚ö†Ô∏è ${check.error}</div>` : ''}
                    ${check.mode ? `<div class="details">Mode: ${check.mode}</div>` : ''}
                    ${check.cpu_percent ? `<div class="details">CPU: ${check.cpu_percent.toFixed(1)}%</div>` : ''}
                    ${check.memory_percent ? `<div class="details">Memory: ${check.memory_percent.toFixed(1)}%</div>` : ''}
                    ${check.admins !== undefined ? `<div class="details">Admins: ${check.admins}</div>` : ''}
                `;
                
                checksGrid.appendChild(checkItem);
            }
        }
        
        function handleAlerts(data) {
            const alerts = data.active_alerts || [];
            const criticalAlerts = alerts.filter(a => a.severity === 'critical');
            const warnings = alerts.filter(a => a.severity === 'warning');
            
            // Handle critical alerts
            if (criticalAlerts.length > 0) {
                const alert = criticalAlerts[0];
                const alertId = `${alert.severity}_${alert.message}`;
                
                if (!acknowledgedAlerts.has(alertId)) {
                    showCriticalAlert(alert.message, alert.details);
                }
            } else {
                hideCriticalAlert();
            }
            
            // Handle warnings
            if (warnings.length > 0 && criticalAlerts.length === 0) {
                const warning = warnings[0];
                const warningId = `${warning.severity}_${warning.message}`;
                
                if (!acknowledgedAlerts.has(warningId)) {
                    showWarning(warning.message, warning.details);
                }
            } else if (criticalAlerts.length === 0) {
                hideWarning();
            }
        }
        
        function showCriticalAlert(message, details) {
            document.getElementById('alertMessage').textContent = message;
            document.getElementById('alertDetails').textContent = details || '';
            document.getElementById('criticalAlert').classList.add('active');
            playSound();
        }
        
        function hideCriticalAlert() {
            document.getElementById('criticalAlert').classList.remove('active');
            stopSound();
        }
        
        function showWarning(message, details) {
            document.getElementById('warningMessage').textContent = message + (details ? ' - ' + details : '');
            document.getElementById('warningAlert').classList.add('active');
        }
        
        function hideWarning() {
            document.getElementById('warningAlert').classList.remove('active');
        }
        
        function acknowledgeAlert() {
            const message = document.getElementById('alertMessage').textContent;
            acknowledgedAlerts.add('critical_' + message);
            hideCriticalAlert();
            
            // Send acknowledgment to server
            fetch('/api/monitor/acknowledge', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({alert_id: 'critical_' + message})
            });
        }
        
        function acknowledgeWarning() {
            const message = document.getElementById('warningMessage').textContent;
            acknowledgedAlerts.add('warning_' + message);
            hideWarning();
            
            // Send acknowledgment to server
            fetch('/api/monitor/acknowledge', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({alert_id: 'warning_' + message})
            });
        }
        
        function playSound() {
            if (!soundPlaying) {
                alertSound.play().catch(e => console.log('Audio play failed:', e));
                soundPlaying = true;
            }
        }
        
        function stopSound() {
            if (soundPlaying) {
                alertSound.pause();
                alertSound.currentTime = 0;
                soundPlaying = false;
            }
        }
        
        // Control panel functions
        async function loadBotStats() {
            try {
                const response = await fetch('/api/bot/stats');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('totalUsers').textContent = data.total_users || '-';
                    document.getElementById('subscribedUsers').textContent = data.subscribed_users || '-';
                    document.getElementById('activeUsers').textContent = data.subscribed_users || '-';
                    document.getElementById('instantStatus').textContent = data.instant_alerts_enabled ? 'Active ‚úì' : 'Disabled ‚úó';
                    document.getElementById('summaryStatus').textContent = data.summary_enabled ? 'Active ‚úì' : 'Disabled ‚úó';
                    
                    // Update indicator
                    const indicator = document.getElementById('notifIndicator');
                    if (data.instant_alerts_enabled && data.summary_enabled) {
                        indicator.className = 'status-indicator active';
                    } else {
                        indicator.className = 'status-indicator inactive';
                    }
                }
            } catch (error) {
                console.error('Error loading bot stats:', error);
            }
        }
        
        async function sendTestNotification() {
            if (confirm('Send a test notification to all subscribed users?')) {
                try {
                    const response = await fetch('/api/bot/test-notification', {method: 'POST'});
                    if (response.ok) {
                        alert('‚úÖ Test notification sent successfully!');
                    } else {
                        alert('‚ùå Failed to send test notification');
                    }
                } catch (error) {
                    alert('‚ùå Error: ' + error.message);
                }
            }
        }
        
        function viewBotLogs() {
            alert('Bot logs can be viewed in the Replit console.\nClick on "Telegram Bot" workflow to see real-time logs.');
        }
        
        function restartBot() {
            alert('To restart the bot:\n1. Go to Workflows in Replit\n2. Stop "Telegram Bot" workflow\n3. Start it again\n\nOr use the Replit interface to restart all workflows.');
        }
        
        async function viewUserStats() {
            try {
                const response = await fetch('/api/bot/users');
                if (response.ok) {
                    const data = await response.json();
                    let message = 'üìä USER STATISTICS\\n\\n';
                    data.users.forEach((user, idx) => {
                        message += `${idx + 1}. ${user.username}\\n`;
                        message += `   Language: ${user.language.toUpperCase()}\\n`;
                        message += `   Auto-signals: ${user.auto_signals ? 'ON' : 'OFF'}\\n\\n`;
                    });
                    alert(message);
                } else {
                    alert('‚ùå Failed to load user statistics');
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }
        
        // Environment status tracking
        let lastProductionStatus = null;
        let productionAlertShown = false;
        
        async function checkEnvironmentStatus() {
            try {
                const response = await fetch('/api/monitor/production-status');
                if (!response.ok) {
                    console.error('Failed to fetch environment status');
                    return;
                }
                
                const data = await response.json();
                updateEnvironmentCards(data);
                handleProductionAlert(data.production);
                updateDeploymentConfig(data.deployment_config);
            } catch (error) {
                console.error('Error checking environment status:', error);
            }
        }
        
        function updateEnvironmentCards(data) {
            const dev = data.development;
            const prod = data.production;
            
            // Update Development Card
            updateEnvCard('dev', dev);
            
            // Update Production Card
            updateEnvCard('prod', prod);
        }
        
        function updateEnvCard(envType, envData) {
            const prefix = envType;
            const card = document.getElementById(`${prefix}EnvCard`);
            const badge = document.getElementById(`${prefix}EnvBadge`);
            const lastSeen = document.getElementById(`${prefix}LastSeen`);
            const secondsAgo = document.getElementById(`${prefix}SecondsAgo`);
            const status = document.getElementById(`${prefix}Status`);
            
            if (!envData) {
                card.className = 'env-card unknown';
                badge.className = 'env-badge unknown';
                badge.textContent = 'NO DATA';
                lastSeen.textContent = '-';
                secondsAgo.textContent = '-';
                status.textContent = 'No data available';
                return;
            }
            
            // Update badge and card class based on health
            const isHealthy = envData.healthy;
            const statusClass = isHealthy ? 'online' : (envData.last_seen ? 'offline' : 'unknown');
            
            card.className = `env-card ${statusClass}`;
            badge.className = `env-badge ${statusClass}`;
            badge.textContent = isHealthy ? '‚úÖ ONLINE' : (envData.last_seen ? 'üî¥ OFFLINE' : '‚ö†Ô∏è NO DATA');
            
            // Update details
            if (envData.last_seen) {
                const lastSeenDate = new Date(envData.last_seen);
                lastSeen.textContent = lastSeenDate.toLocaleString();
            } else {
                lastSeen.textContent = 'Never';
            }
            
            if (envData.seconds_ago !== null && envData.seconds_ago !== undefined) {
                const mins = Math.floor(envData.seconds_ago / 60);
                const secs = envData.seconds_ago % 60;
                if (mins > 0) {
                    secondsAgo.textContent = `${mins}m ${secs}s ago`;
                } else {
                    secondsAgo.textContent = `${secs}s ago`;
                }
                
                // Add critical styling if offline for too long
                if (envData.seconds_ago > 180 && envType === 'prod') {
                    secondsAgo.className = 'env-detail-value critical';
                } else {
                    secondsAgo.className = 'env-detail-value';
                }
            } else {
                secondsAgo.textContent = '-';
            }
            
            status.textContent = envData.status || 'Unknown';
            if (!isHealthy && envData.error) {
                status.textContent = envData.error;
            }
        }
        
        function handleProductionAlert(prodData) {
            if (!prodData) return;
            
            const isProductionOffline = !prodData.healthy && prodData.last_seen;
            
            // Check if production went from online to offline
            if (isProductionOffline && !productionAlertShown) {
                // Show critical alert
                const message = 'üö® PRODUCTION BOT IS OFFLINE! üö®';
                const details = prodData.error || 'Production Telegram bot is not responding to heartbeat checks';
                showCriticalAlert(message, details);
                productionAlertShown = true;
            } else if (!isProductionOffline && productionAlertShown) {
                // Production came back online
                productionAlertShown = false;
                hideCriticalAlert();
            }
        }
        
        function updateDeploymentConfig(configData) {
            const container = document.getElementById('deploymentConfigItems');
            if (!configData) {
                container.innerHTML = '<p style="color: #666;">Loading configuration...</p>';
                return;
            }
            
            let html = '';
            
            // Deployment Type
            const isVM = configData.deployment_type === 'vm';
            html += `
                <div class="config-item">
                    <div class="config-icon ${isVM ? 'ok' : 'error'}">
                        ${isVM ? '‚úì' : '‚úó'}
                    </div>
                    <div class="config-text">
                        <strong>Deployment Type:</strong> ${configData.deployment_type?.toUpperCase() || 'UNKNOWN'}
                        ${!isVM ? '<br><small style="color: #991b1b;">‚ö†Ô∏è Recommended: Use Reserved VM for 24/7 operation</small>' : ''}
                    </div>
                </div>
            `;
            
            // Script Status
            const scriptOk = configData.healthy || false;
            html += `
                <div class="config-item">
                    <div class="config-icon ${scriptOk ? 'ok' : 'error'}">
                        ${scriptOk ? '‚úì' : '‚úó'}
                    </div>
                    <div class="config-text">
                        <strong>Production Script:</strong> ${configData.status || 'Unknown'}
                        ${configData.error ? `<br><small style="color: #991b1b;">‚ö†Ô∏è ${configData.error}</small>` : ''}
                    </div>
                </div>
            `;
            
            // Production Readiness
            const isReady = configData.healthy && isVM;
            html += `
                <div class="config-item">
                    <div class="config-icon ${isReady ? 'ok' : 'error'}">
                        ${isReady ? '‚úì' : '‚úó'}
                    </div>
                    <div class="config-text">
                        <strong>Production Ready:</strong> ${isReady ? 'Yes - Ready for 24/7 operation' : 'No - Configuration changes needed'}
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // Initial check
        checkHealth();
        loadBotStats();
        checkEnvironmentStatus();
        
        // Auto-refresh every 10 seconds
        setInterval(checkHealth, 10000);
        setInterval(loadBotStats, 15000);
        setInterval(checkEnvironmentStatus, 10000);
    </script>
</body>
</html>
